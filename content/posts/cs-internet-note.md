---
title: '计算机网络基础知识梳理'
date: 2025-01-02T12:44:29+08:00
layout: "post"
images: 
  - "/avatar.jpg"   # 设置封面图
description: "the note for the final exam"     
categories: ["笔记"]
tags: ["内功"]
draft: false
---

# 计算机网络

## 三大基本网络体系结构

### OCI（七层协议体系结构）

- 应用层
- 表示层
- 会话层
- 运输层
- 网络层
- 数据链路层
- 物理层

### TCP/IP协议体系结构

- 应用层（各种应用层协议）
- 运输层（TCP/IP）
- 网际层（IP）
- 网络接口层（无具体内容）

### 五层协议

- 应用层
- 运输层
- 网络层
- 数据链路层
- 物理层

## 物理层

> 尽可能屏蔽掉不同传输媒体和通信手段的差异，为数据链路层传下来的**数据比特流**提供统一的数据传输服务

**信号** ：数据的电气或者电磁的表现

- 模拟信号：消息的参数的取值是**连续**的
- 数字信号：消息的参数的取值是**离散**的

**信道**：向某一个方向传输数据的媒体

- 单工通信：只有一个发送方
- 半双工通信：双方都可以发送
- 双工通信：双方可以同时发送同时接收

**调制**

- 基带调制（基本频带信号）：只对**基带信号**的波形转换，数字信号转换为另一种数字信号.(编码)
- 带通调制：使用**barrier**（载波），将基带信号的频率调高，转换为模拟信号，得到**带通信号**。

### 传输媒体（有线）

**双绞线**：使用两根互相绞合的绝缘铜线，绞合度越高，数据传输率越快。

- UTP（Unsheilded Twist Pair）
- STP（Sheiled Twist Pair）屏蔽双绞线：带有额外的铝箔屏蔽层

**同轴电缆**：内导体铜质芯线 + 绝缘层 + 外导体屏蔽层 + 绝缘保护套层

**光缆**：通过传递光脉冲进行通信。

### 信道复用技术

**FDM**（Frequency Division Multiplexing 频分复用）：将整个带宽平均分为多份频带，分别分配给多个用户，该用户自始自终都占用该频带。

**TDM**（Time Division Multiplexing 时分复用）

- 每个用户获得固定在每一个TDM帧（将时间划分为等长的时分复用帧）的**时隙**
- 时隙周期性出现，用户跟着周期性工作
- 所有用户在不同时间，占用同样的频带宽度（空间）
- 导致时间利用率不高，引入STDM（Static TDM 统计时分复用），按需动态分配时隙

**FDMA**（Frequency Division Multiplexing Access 频分多址）

**TDMA**（Time Division Multiplexing Access 时分多址）

**WDM**（Wavelength Division Multiplexing 波分复用）

- 光的频分复用

**CDM** （Code Division Multiplexing 码分复用)

- 在同一时间内使用同样的频带，通过挑选不同的**码型**,达到复用的效果

## 数据链路层

数据链路层协议数据单元：**帧**

数据链路层信道类型

-  点对点信道
   - 拨号接入的PPP、PPPOE协议（实现拨号上网）
   - 以太网中交换机和主机的点对点链路
-  广播信道
   - 总线以太网
   - 802.11无线局域网
   - 卫星网络

### 封装成帧

在一段数据的前后分别添加**首部和尾部**，构成一个完整的帧（**帧定界**）

**MTU**（Maximum Transfer Unit）最大传输数据的长度上限

控制字符作为帧定界符： **SOH**（Start of Header) **EOT**（End Of Transmission)

### 透明传输

问题：如果在传输的过程中数据中含有和SOH或者EOT相同的字符，就会导致错误读取到帧头或者帧尾。

- 字符填充：在数据中每一个冲突字符前，添加一个固定的转义字符`ESC`，当解析过程中碰到`ESC`就删除当前`ESC`
- [比特填充](https://en.wikipedia.org/wiki/Bit_stuffing)

### 差错检测

数据链路层在传输过程中可能出现的比特传输的差错。

### CRC（Cyclic Redundancy Check 循环冗余检验)

原理：利用整除原理（被除数 + 余数 = 一定会被原来的除数整除），来判断发送出的比特是否出现差错

- 确定好除数P(n + 1位)
- 将数据划分为（k 位）组（称为M）
- 在每一组后面添加**FCS**（Frame Check Sequence  帧检验序列 为了检错而添加的冗余码）n 位，构成一个帧（共k + n位）发出。

**FCS**（此处由CRC运算得到，称为**CRC冗余码**）计算

- 将原数据M * 2<sup>n</sup>,（在二进制表示中也就是在原数据后加上n个0）得到的新值除以P，得到的（n位）余数则就是得到的CRC冗余码，将其添加在数据组后方。
- 接收方得到（K + N）位数据之后，除P
  - 余数 = 0，接收
  - 余数 != 0，丢弃

**FCS可以通过CRC这种计算方法得出，但是CRC并不是得到FCS的唯一方法.**

### PPP(Point-To-Point)

对于点对点的链路，最简单的数据链路层协议。共有三个组成部分

- 一个将IP数据报封装到串行链路的方法
- 一个**LCP**（Link Control Protocol)
- 一套**NCP** （Network Control Protocol)

### 局域网链路层：基于广播信道

[局域网拓扑结构](https://zh.wikipedia.org/zh-cn/%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91)：星形网、环形网、总线网

**局域网中的数据链路层**（两个子层）

- **LLC**（Logical Link Control 逻辑链路控制子层）：传输媒体无关
- **MAC** （Medium Access Control 媒体接入控制子层)：传输媒体相关

### CSMA/CD (Carrier Sense Multiple Access with Collision Detection)

#### 以太网特点

采用灵活的无连接的工作方式

- 不必先建立连接就直接发送数据
- **总线型**：使用**半双工**方式工作
- 数据帧不进行编号，也不要求对方发送确认
- 提供不可靠的交付服务
- 以太网采用最简单的随机接入的方式（使用CSMA/CD协议减少冲突概率）

**载波监听多点接入/碰撞检测**

- 多点接入：总线型网络，多个主机（计算机）以多点接入的方式连接到一根总线上
- 载波监听：边发送边监听，每个站都在不停的检测信道是否处于忙状态。
- 碰撞检测：适配器不停检测信道上的**信号电压**变化情况，检测电压是否超过门限值，说明是否产生了碰撞。
  - 适配器立即停止发送
  - 等待一段随机时间之后，再次发送。（采用截断二进制指数退避的方式重传）

![image-20250101142852637](/cs-internet-note//image-20250101142852637.png)

**争用期**（碰撞窗口）：以太网中，端到端之间的往返时延（RTT）2τ = 51.2微秒。在争用期这段时间还没有检测到碰撞，就能肯定未发生碰撞。

> 对于10Mbit/s以太网，在争用期内可以发送512bit，64字节。并且**以太网规定了最短有效帧的长度为64字节**
>
> - 若前64字节没有发生冲突，那么后续的数据就不会发生冲突
> - 所有长度小于64字节的帧都是异常中止的无效帧，立即丢弃。
> - 以太网还规定了**帧间最小间隔为9.6微秒**

### 以太网的MAC层

MAC（Media access Control Address 物理地址 硬件地址）

- 48位 = 24位 （**OUI** 组织唯一标识符）+ 24位（扩展标识符）
- **I/G**（Individual / Group）：地址字段的第一字节的最低位数
  - **单站地址**：0
  - **组地址**：1 多播
  - **广播地址**：所有四十八位全都为1, **只能作为目的地址使用**
- **G/L**（Global/Local）：地址字段的最低第2位
  - **全球管理**：0 全球唯一
  - **本地管理**：1 地址可以被用户任意分配

以太网V2的MAC帧格式（区别于802.3）的MAC帧组成

![image-20250101145440949](/cs-internet-note/image-20250101145440949.png)

**类型字段**：用于标识上一层使用的协议，便交付给相对应的协议

**MAC客户数据字段**：最小帧长度（64字节） - 首部尾部（18字节）= IP数据报最小长度（46字节）

- 如果IP数据报长度小于46字节，将在数据字段后添加**整数字节的填充字段**，保证最小帧长度

**物理层首部8字节**：前同步码（7Byte） + 帧开始定界符（1Byte）

- 前同步码的存在，是为了迅速实现MAC帧的比特同步

### 网桥和以太网交换机

- 工作在数据链路层
- 均可实现根据MAC地址的目标地址收到的帧进行转发和过滤，丢弃
- 交换机：多端口的网桥，能够提升以太网性能

以太网交换机特点

- 内部的帧交换表（**地址表**）是通过**自学习算法**自动的逐渐的建立起来的。就是一个CAM（内容可寻址存储器）
- 用专用的交换结构芯片，使**用硬件转发**，快于使用**软件转发**的网桥 

## 网络层

### 虚电路服务和数据报服务

- 虚电路服务提供可靠的面向连接的通信，所有的数据报分组都沿着一条虚电路传送
- 数据报服务提供不可靠的无连接的，尽最大努力交付的，每一个数据分组都独立的进行发送

### 数据层面和控制层面

**数据层面**：根据转发表，将收到的分组转发出去，使用硬件转发，快。

**控制层面**：使用路由算法计算路由，创建并更新本路由器的路由表，协同工作，软件计算，慢。

**控制平面协议**

- **ARP**（Address Resolution Protocol）地址解析协议
- **ICMP**（Internet Control Message Protocol）网际控制报文协议
- **IGMP**（Internet Group Management Protocol）网际组管理协议

> 使用转发器、网桥、交换机不称作为网络互连，他们仍然是一个网络（局域网），网络互连只能使用路由器连接。

### **IP地址**

**IP地址**：32位标识符。互联网上的每台**主机**和**路由器**的**每一个接口**，分配的在全世界唯一的IP地址

IP地址 （两级结构）= 网络号 + 主机号

### IP地址的分类

![image-20250101153934158](/cs-internet-note/image-20250101153934158.png)

ABC均为单播地址

### CIDR（Classless Inter-Domain Routing  无分类编址）

IP地址 = 网络前缀 + 主机号

> 单凭借`128.14.35.7`这一个IP地址，这是无法指明为一个网络地址的。

### IP数据报的格式

IP数据报 = 首部 + 数据部分

![image-20250101164443414](/cs-internet-note/image-20250101164443414.png)

- 首部的**固定部分长度为20字节**
- 首部长度字段（4位，表示15个单位，一个单位4Byte），因此首部的最大长度为60字节
- 标志（3）
  - **MF**（More Fragment) 最低位，**表示后面还有分片**
  - **DF**（Don't Fragment) 中间位，只有当**DF=0**时，才允许分片 
- 片偏移： 较长的分组在分片之后，某一片在原分组的相对位置
  - 片偏移以8个字节为偏移单位
- 首部检验和：只是检验数据报的首部，不检验数据部分，采用简单的**反码算数运算求和**的计算方法求校验和

### IP数据报分组的转发

- 路由器转发表存储的最主要的路由为（目的网络地址，下一跳地址）
  - 查找转发表的过程就是逐行寻找前缀是否匹配

**最长前缀匹配**

因为在转发表中存储的是目的网络地址，所以在匹配的过程中，可能会得到的不止一个的匹配结果，所以**最长前缀匹配原则**，只选择前缀最长的作为匹配的前缀，**因为前缀越小，地址块越小，路由就越具体**

**转发表中特殊的2种路由**

- 特定主机路由：为特定的目的主机的IP地址专门指明的一个路由
  - 网络前缀就是`a.b.c.d/32`
  - 放置在转发表的最前面
- 默认路由
  - 不管最终目的的网络和谁匹配，都用指定的路由器R来处理
  - 使用特殊前缀`0.0.0.0/0`表示
  - 只要未匹配到，那么一律选择默认的路由

### ICMP

允许主机报告差错情况，和提供有关异常情况的报告。

**ICMP是互联网的标准协议，是IP层的协议**

- 回送请求和回答：测试目的站是否可达，以及了解其有关的状态
- ICMP差错报告报文
  - 对ICMP差错报告报文，不再发送ICMP差错报告报文
  - 对第一个分片的数据报片以及后续数据报片都不发送ICMP差错报告报文
  - 多播地址不发送
  - 特殊地址不发送（127.0.0.0 、0.0.0.0)

### 路由选择

**AS（Autonomous System）自治系统**

指的是在单一技术管理下的许多网络、IP地址和路由器组成的系统

**分层次的路由选择协议**：使用动态的、分布式路由选择协议，将整个互联网分成许多较小的AS（自治系统）

- 自治系统之间的路由选择（域间路由选择）
- 自治系统的内部的路由选择（域内路由选择）

**外部网关协议**：在不同的自治系统之间进行路由选择的协议（**BGP-4**）

**内部网关协议**：在一个自治系统内部使用的路由选择协议（**RIP** **OSPF**）

**RIP**（Routing Information Protocol）：是一种分布式的基于**距离向量**的路由选择协议

- 每一个路由器都要维护从他自己到每一个目的网络的距离记录
- 仅仅和相邻的路由器交换信息
- 按照固定的时间间隔交换路由信息
- **“距离"** => 跳数最大16，标识为不可达路由器

**距离向量算法**简述：

- 收到相邻路由器传来路由信息表
- 将路由信息表中距离 + 1
- 修改下一跳路由器为该相邻路由器
- 自身路由信息表和新路由信息表进行判断，若新信息距离更短则更新信息，若不存在，则直接加入新目的网络

缺点：”好消息传的快，坏消息传的慢“

> 当一个网故障时，双方都误认为对方能够到达网1，不断的相互更新，直到双方都达到16（不可达）的时候，才会发现网1时不可达的，

**OSPF**（Open Shortest Path First 开放最短路径优先）:分布式的基于**链路状态**路由选择协议（使用SPF Djikstra）

- 使用洪泛法，向该自治系统中所有路由器发送消息
- 告知本路由器相邻的所有路由器的**链路状态**（说明和哪些路由器相邻，以及该链路的**度量**）
- 当链路状态发生变化的时候或者每间隔一段时间，路由器就会用洪泛法向所有路由器发送信息

最终建立每个路由器为都建立起全网的拓扑结构图。

## 运输层

> 网络层为主机之间的通信提供服务。运输层为应用层之间的通信提供服务

**UDP（User Datagram Protocol 用户数据报协议）**

**TCP（Transmission Control Protocol 传输控制协议）**

**TPDU（Transport Protocol Data Unit 运输协议数据单元）**：两个对等运输实体在通信时传送的数据单位

- TCP传送的数据单位TCP报文段（**segment**）
- UDP -> 用户数据报 UDP报文

> IP协议工作在网络层，UDP TCP协议工作在运输层

**运输层中的多路复用分用**

- 应用进程都可以通过运输层再运送给IP层
- 运输层从IP层收到发给应用进程的数据之后，交给**指明的对应的**各应用进程

**端口（Port）**

- 16位端口进行标志,允许有65536个不同的端口号
- 为了标志本地计算机应用层的各个进程

### UDP

只是在IP数据报服务之上增加了一些功能

- 复用和分用
- **差错检测**（是的，UDP是有差错检测的）

**主要特点**：

1. 无连接
2. 没有拥塞控制
3. 面向报文的连接（一次只传送和交付一个完整的报文）
4. 首部只有**8个字节**

对于面向报文的连接，发送方对从应用层交下来的报文，按原样发送。接收方对IP层交上来的UDP用户数据报，只是去除首部之后就原封不动地交付给上层的应用进程。

![image-20250101210742243](/cs-internet-note//image-20250101210742243.png)

注意的是：**UDP中的校验和是把首部和数据部分一起都检验**

### TCP

TCP的主要特点

1. TCP是面向连接的
2. 提供可靠交付的服务
3. 只有两个端点连接，每一条TCP连接都只能是点对点的
4. 提供全双工的通信
5. 面向字节流

> 关于面向字节流，虽然上层交付给TCP的数据是以块的形式发送的，但TCP将其看作一系列的字节序列，忽略数据快的对应大小关系。所以TCP**不保证**在传输过程中，数据块大小和对应关系不发生改变，但是一定会保证字节流数据完全一样。

#### 首部格式

![image-20250101212926537](/cs-internet-note/image-20250101212926537.png)

- **序号**：TCP连接中的每一个字节流中的每一个字节都一个序号，该字段的值指的是本报文段（segment）发送的数据的第一个字节的序号
- **确认号**：4字节，**期望收到**对方下一个报文段的数据的第一个字节的序号
  - 确认号为N，说明到序号N-1为止的所有的数据都已经正确的收到
- **数据偏移**(首部长度)：指出TCP报文段**数据开始处**，到报文段开始处距离大小
- **ACK**，只有当ACK=1时，确认号字段才有效，ACK=0确认号字段无效
- **PUSH**：当收到PUSH位的报文段之后，就尽快的交付数据给应用进程
- **RST**：表明连接已经崩溃，需要重新建立连接
- **SYN（SYNchronizaton）**：当SYN控制位为1时，表示这是一个**连接请求**或者**连接接受**的报文（正在建立连接）
- **FIN**：释放连接位
- **窗口**：，明确指出允许对方发送的数据量，经常在动态的变化
- 校验和，在计算校验和的时候，要在TCP报文段前面加上12字节的**伪首部**

### 停止等待协议

- 发送一个分组就停止发送，等待接收方返回确认信号
- 超时重传
- 暂存副本，以备重发

### 连续ARQ协议

- 发送方维持一个**发送窗口**
- 发送窗口滑动，发送方每收到一个确认，就将发送窗口向前滑动一个分组的位置
- **累积确认**：**发送方只对按顺序到达的最后一个分组发送确认**，标识这个到分组为止的所有分组都已经正确的收到了
- 采用**GO-back-N**回退N个分组的协议，需要退回来重传已经发过的**N个分组*

### TCP的可靠传输实现

TCP的滑动窗口是基于字节的维护的滑动窗口，序号是以字节为单位的

- 发送窗口的大小，实际上是根据接收窗口设置的

### 滑动窗口实现流量控制

#### 持续计时器

为了解决零窗口请求发出结束后，接收方再次发送请求该请求丢失，导致死锁的情况。

只要TCP连接的一方收到了对方的零窗口通知，就启动该持续计时器，如果设置的时间到期，发送一个**零窗口探测报文段**确认当前窗口值大小。

### 拥塞控制

防止过多的数据注入到网络中，是一个全局性的过程涉及到所有的主机以及路由器。

**TCP采用滑动窗口的方法进行拥塞控制**

- 发送方维持一个拥塞窗口**cwnd (Congestion Window)**，该窗口大小取决于网络的拥塞程度，动态变化
- 真正的发送窗口值：**Min（接收方通知的窗口值，拥塞窗口值）**

**发送方判断拥塞的方法**

- 超时重传计时器超时：**网络已经出现了拥塞**
- 收到三个重复的确认：**网络可能会出现拥塞**

**TCP拥塞控制算法**

**传输轮次**：一个传输轮次所经历的时间就是往返时间RTT

> 当把拥塞窗口cwnd允许发送的所有的报文段都连续发送出去之后，并且收到了对已经发送出去的最后一个字节的确认的时间

**慢开始**

- 由小到大逐渐增大拥塞窗口数值

- 发送方每收到一个对新报文段的确认，cwnd + 1

- **每经过一个传输轮次（RTT），拥塞窗口就会加倍**

- **sshthresh** 慢开始门限

  - 当cwnd < ssthresh 慢开始算法
  - cwnd > sshthresh 拥塞避免算法
  - cwnd = sshthresh 均可使用

**拥塞避免**

- 每经过一个RTT，cwnd = cwnd  + 1
- 拥塞窗口按线性规律缓慢增长

只要当网络出现拥塞时（重传定时器超时）就会出现以下变化

- sshthresh = max（cwnd / 2, 2)
- cwnd = 1
- 执行慢开始算法

**快重传FR（Fast Retransmission）**

- 发送方只要连续收到**三个重复的确认ACK**，就立即进行重传（‘快重传’）

**快恢复FR（Fast Recovery)**

- ssthresh = (cwnd / 2)
- cwnd = sshthresh
- 执行拥塞避免算法，让拥塞窗口缓慢的线性增大

### TCP连接建立

**握手**：TCP建立连接的过程

**三报文握手**：在客户和服务器之间交换3个TCP报文段。

**连接建立准备工作** : TCP服务器进程先创建传输控制块TCB，准备好接收客户进程的连接请求

1. 客户A主动发送连接请求报文段，SYN = 1, seq = X

> 选择序号为x，表明传送数据时的第一个和数据字节序号为x
>
> **TCP规定**：SYN报文段（SYN = 1）的报文段，不能携带数据，**但要消耗掉一个序号**

2. 服务器B收到连接请求，发回确认请求报文段，SYN = 1, ack = X + 1, ACK = 1, seq = y

> 同上，该报文段不能携带数据，同样需要消耗掉一个序号

3. （1）此时A收到确认请求报文段，通知上层应用连接已经建立，并返回确认，ACK = 1, ack = y + 1, seq = x + 1

> 上述则为ACK报文段，可以携带数据，但不消耗序号，下一个数据报文段的序号仍然可以是seq = x + 1

4. (2) B收到主机A的确认之后，也通知上层应用进程，TCP连接建立成功，可以开始数据传送

### TCP连接释放

**四报文握手**

1. A的应用进程先向其TCP发出连接释放报文段，并停止再发送数据，**主动关闭**TCP连接。FIN = 1, seq = u

> FIN报文即使不携带数据，也要消耗掉一个序号

2. B发出A报文的确认，ACK = 1, ack = u + 1 , seq =  v。

> TCP服务器B进程此时通知高层应用进程
>
> 此时TCP连接处于半关闭（half-close）状态，如果B还有数据要发送，A仍要接收

3. 上层应用进程通知服务器，释放连接。 FIN = 1 ACK  = 1 ack = u + 1 seq = w

4. A收到连接释放报文段之后，必须发出确认。 FIN = 1 ACK = 1 ack = w + 1 seq = u + 1

> 一直到此刻，TCP连接还没有完全释放掉，经过**时间等待计时器**设置的2 MSL之后，A才完全释放TCP连接

**保活计时器**：用于方式TCP连接出现长时期空闲状态

- 服务器过了固定时间（通常是2小时）未收到客户的消息，发送探测报文段
- 若发送了10个探测报文段（每一个间隔75s），未响应，客户出现故障，终止连接

## 应用层

### 域名系统DNS（Domain Name System）

域名采用层次树状结构的命名方法，是一个联机**分布式数据库系统**采用客户服务器方式，**UDP**通信

域名服务器根据所的作用分为

1. 根域名服务器
2. 顶级域名（TLD）服务器
3. 权限域名服务器 负责一个Zone的域名服务器
4. 本地（默认）域名服务器

**域名解析分为**

- 递归查询（比较少用）
- 迭代查询

### 电子邮件

- SMTP：简单邮件发送协议
- POP3和IMAP: 邮件读取协议

电子邮件系统组成：

- 用户代理
- 邮件服务器
- 邮件发送和读取协议（都使用TCP连接可靠地传送邮件）

**SMTP**

- 是一个基于文本的（ASCII码）协议
- SMTP采用命令-响应的方式进行交互

**POP3（Post Office Protocol 邮局协议)**

- 支持用户鉴别
- POP3服务器会删除被用户读取了的邮件

**IMAP（Internet Message Access Protocol 网际报文存取协议）**

- 用户直接在IMAP服务器上创建和管理文件夹
- 想要查阅邮件，必须要先联网
- 连接以后只下载邮件首部

![image-20250102123339992](/cs-internet-note/image-20250102123339992.png)

### DHCP（Dynamic Host Configuration Protocol 动态主机配置协议）

连接到互联网的计算机协议软件需要正确配置的四大参数

- IP地址
- 子网掩码
- 默认路由器IP地址
- 域名服务器IP地址

DHCP提供了即插即用连网的机制，允许计算机直接加入网络自动获取IP地址，不用手工配置。


